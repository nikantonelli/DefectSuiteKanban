<!DOCTYPE html>
<html>
<head>
    <title>Kanban Board</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                !function(){var e=window.Ext4||window.Ext;e.define("Rally.apps.common.RowSettingsField",{alias:"widget.rowsettingsfield",extend:"Ext.form.FieldContainer",requires:["Rally.ui.CheckboxField","Rally.ui.combobox.ComboBox","Rally.ui.plugin.FieldValidationUi","Rally.data.ModelFactory","Rally.data.wsapi.ModelBuilder"],mixins:{field:"Ext.form.field.Field"},layout:"hbox",cls:"row-settings",config:{value:void 0,isAllowedFieldFn:e.emptyFn,explicitFields:[],modelNames:["userstory","defect"],whiteListFields:[]},initComponent:function(){this.callParent(arguments),this.mixins.field.initField.call(this),this.add([{xtype:"rallycheckboxfield",name:"showRows",boxLabel:"",margin:"0",submitValue:!1,value:this.getValue().showRows,listeners:{change:function(e,i){this.down("rallycombobox").setDisabled(!i)},scope:this}},{xtype:"rallycombobox",plugins:["rallyfieldvalidationui"],name:"rowsField",margin:"0 6px",width:130,emptyText:"Choose Field...",displayField:"name",valueField:"value",disabled:"true"!==this.getValue().showRows,editable:!1,submitValue:!1,storeType:"Ext.data.Store",storeConfig:{remoteFilter:!1,fields:["name","value"],data:[]}}]),this._loadModels()},_loadModels:function(){Rally.data.ModelFactory.getModels({types:this.getModelNames(),context:this.context,success:this._onModelsRetrieved,scope:this})},_onModelsRetrieved:function(i){var t=_.uniq(e.Array.merge(this.explicitFields,this._getRowableFields(_.values(i))),"name"),l=this.down("rallycombobox");l.getStore().loadData(_.sortBy(t,"name")),l.setValue(this.getValue().rowsField),this.fireEvent("ready",this)},_getRowableFields:function(e){var i=Rally.data.wsapi.ModelBuilder.buildCompositeArtifact(e,this.context),t=i.getFields(),l=_.filter(t,function(t){var l=t.attributeDefinition;return l&&!l.Hidden&&l.Sortable&&(i.getModelsForField(t).length===e.length&&this.isAllowedFieldFn(t)||_.contains(this.whiteListFields,t.displayName))},this);return _.map(l,function(e){return{name:e.displayName,value:e.name}})},getSubmitData:function(){var e={},i=this.down("rallycheckboxfield"),t=this.down("rallycombobox"),l=i.getValue()&&!_.isEmpty(t.getValue());return e[i.name]=l,l&&(e[t.name]=t.getValue()),e},refreshWithNewModelType:function(e){this.setModelNames([e]),this._loadModels()}})}();
                !function(){var e=window.Ext4||window.Ext;e.define("Rally.apps.kanban.Column",{extend:"Rally.ui.cardboard.Column",alias:"widget.kanbancolumn",config:{hideReleasedCards:!1},getStoreFilter:function(a){var n=[];return e.Array.push(n,this.callParent(arguments)),"HierarchicalRequirement"===a.elementName&&this.context.getSubscription().StoryHierarchyEnabled&&n.push({property:"DirectChildrenCount",value:0}),this.hideReleasedCards&&n.push({property:"Release",value:null}),n}})}();
                !function(){var t=window.Ext4||window.Ext;t.define("Rally.apps.kanban.ColumnCardFieldPicker",{extend:"Rally.ui.picker.FieldPicker",alias:"widget.kanbancolumncardfieldpicker",margin:0,config:{rightInitialText:"Apply to All",rightUpdateText:"Remove from All",rightCls:"rui-picker-right-action hyperlink"},initComponent:function(){this.addEvents("rightactionclick"),this.applyToAllFields=[],this.callParent(arguments)},onListItemDeselect:function(i,e){var l=this._getRightActionEl(i);if(l&&e.within(l)){var s=l.getHTML()===this.rightInitialText;if(this.fireEvent("rightactionclick",this,i,this.getValue(),s),s)return this.applyToAllFields.push(i.get(this.selectionKey)),this._selectRowCheckbox(i.get(this.recordKey)),l.update(this.rightUpdateText),!1;t.Array.remove(this.applyToAllFields,i.get(this.selectionKey)),l.update(this.rightInitialText)}else t.Array.remove(this.applyToAllFields,i.get(this.selectionKey));this.callParent(arguments)},getRightListHtml:function(i){var e="";if("Selected Fields"===i.groupSelected&&!t.Array.contains(this.alwaysSelectedValues,i[this.selectionKey])){var l=t.Array.contains(this.applyToAllFields,i[this.selectionKey])?this.rightUpdateText:this.rightInitialText;e='<div class="'+this.rightCls+'">'+l+"</div>"}return e},_getRightActionEl:function(i){var e=t.String.splitWords(this.rightCls).join(".");return this.list.getEl().down(".rui-multi-object-picker-option-id-"+i.get(this.recordKey)+" ."+e)}})}();
                !function(){var e=window.Ext4||window.Ext;e.define("Rally.apps.kanban.ColumnSettingsField",{extend:"Ext.form.field.Base",alias:"widget.kanbancolumnsettingsfield",plugins:["rallyfieldvalidationui"],requires:["Rally.ui.combobox.ComboBox","Rally.ui.TextField","Rally.ui.combobox.FieldValueComboBox","Rally.ui.plugin.FieldValidationUi","Rally.apps.kanban.ColumnCardFieldPicker"],fieldSubTpl:'<div id="{id}" class="settings-grid"></div>',width:600,cls:"column-settings",config:{value:void 0,defaultCardFields:""},onDestroy:function(){this._grid&&(this._grid.destroy(),delete this._grid),this.callParent(arguments)},onRender:function(){this.callParent(arguments),this._store=e.create("Ext.data.Store",{fields:["column","shown","wip","scheduleStateMapping","cardFields"],data:[]}),this._grid=e.create("Rally.ui.grid.Grid",{autoWidth:!0,renderTo:this.inputEl,columnCfgs:this._getColumnCfgs(),showPagingToolbar:!1,showRowActionsColumn:!1,enableRanking:!1,store:this._store,editingConfig:{publishMessages:!1}})},_getColumnCfgs:function(){var t=[{text:"Column",dataIndex:"column",emptyCellText:"None",flex:2},{text:"Show",dataIndex:"shown",flex:1,renderer:function(e){return!0===e?"Yes":"No"},editor:{xtype:"rallycombobox",displayField:"name",valueField:"value",editable:!1,storeType:"Ext.data.Store",storeConfig:{remoteFilter:!1,fields:["name","value"],data:[{name:"Yes",value:!0},{name:"No",value:!1}]}}},{text:"WIP",dataIndex:"wip",flex:1,emptyCellText:"&#8734;",editor:{xtype:"rallytextfield",maskRe:/[0-9]/,validator:function(e){return""===e||e>0&&e<=9999||"WIP must be > 0 and < 9999."},rawToValue:function(e){return""===e?e:parseInt(e,10)}}},{text:"Schedule State Mapping",dataIndex:"scheduleStateMapping",emptyCellText:"--No Mapping--",flex:2,editor:{xtype:"rallyfieldvaluecombobox",model:e.identityFn("HierarchicalRequirement"),field:"ScheduleState",listeners:{ready:function(e){var t={};t[e.displayField]="--No Mapping--",t[e.valueField]="",e.store.insert(0,[t])}}}}];return this.shouldShowColumnLevelFieldPicker&&t.push({text:"Fields",dataIndex:"cardFields",width:300,tdCls:Rally.util.Test.toBrowserTestCssClass("cardfields",""),renderer:this._getRendererForCardFields,scope:this,editor:{xtype:"kanbancolumncardfieldpicker",cls:"card-fields",margin:0,modelTypes:["UserStory","Defect"],autoExpand:!0,alwaysExpanded:!1,hideTrigger:!0,fieldBlackList:["DisplayColor"],alwaysSelectedValues:["FormattedID","Name","Owner"],storeConfig:{autoLoad:!1},listeners:{selectionchange:function(e){e.validate()},rightactionclick:this._updateColumnCardFieldSettings,scope:this}}}),t},getSubmitData:function(){var t={};return t[this.name]=e.JSON.encode(this._buildSettingValue()),t},_getRendererForCardFields:function(t){var i=[];return e.Array.each(this._getCardFields(t),function(e){i.push(e.replace(/^c_/,""))}),i.join(", ")},_getCardFields:function(t){if(e.isString(t)&&t)return t.split(",");var i=["FormattedID","Name","Owner"];return e.Array.each(t,function(t){t&&t.data&&!e.Array.contains(i,t.data.name)&&i.push(t.data.name)}),i},_updateColumnCardFieldSettings:function(t,i,a,l){this._store.each(function(t){if(t.get("shown")){var a=this._getCardFields(t.get("cardFields"));l?e.Array.contains(a,i.get("name"))||a.push(i.get("name")):e.Array.remove(a,i.get("name")),t.set("cardFields",a.join(","))}},this),this._store.loadRawData(this._store.getRange())},_buildSettingValue:function(){var e={};return this._store.each(function(t){if(t.get("shown")&&(e[t.get("column")]={wip:t.get("wip"),scheduleStateMapping:t.get("scheduleStateMapping")},this.shouldShowColumnLevelFieldPicker)){var i=this._getCardFields(t.get("cardFields"));e[t.get("column")].cardFields=i.join(",")}},this),e},getErrors:function(){var t=[];return this._storeLoaded&&!e.Object.getSize(this._buildSettingValue())&&t.push("At least one column must be shown."),t},setValue:function(e){this.callParent(arguments),this._value=e},_getColumnValue:function(t){var i=this._value;return i&&e.JSON.decode(i)[t]},refreshWithNewField:function(t){delete this._storeLoaded,t.getAllowedValueStore().load({callback:function(t){var i=e.Array.map(t,this._recordToGridRow,this);this._store.loadRawData(i),this.fireEvent("ready"),this._storeLoaded=!0},scope:this})},_recordToGridRow:function(t){var i=t.get("StringValue"),a=0===this._store.getCount()?this._getColumnValue(i):null,l={column:i,shown:!1,wip:"",scheduleStateMapping:"",cardFields:this.defaultCardFields};return a&&(e.apply(l,{shown:!0,wip:a.wip,scheduleStateMapping:a.scheduleStateMapping}),a.cardFields&&e.apply(l,{cardFields:a.cardFields})),l}})}();
                !function(){var e=window.Ext4||window.Ext;e.define("Rally.apps.kanban.Settings",{singleton:!0,requires:["Rally.apps.kanban.ColumnSettingsField","Rally.apps.common.RowSettingsField","Rally.ui.combobox.FieldComboBox","Rally.ui.CheckboxField","Rally.ui.plugin.FieldValidationUi"],getFields:function(i){var t=[{name:"groupByField",xtype:"rallyfieldcombobox",model:e.identityFn("DefectSuite"),margin:"10px 0 0 0",fieldLabel:"Columns",listeners:{select:function(e){this.fireEvent("fieldselected",e.getRecord().get("fieldDefinition"))},ready:function(e){e.store.filterBy(function(e){var i=e.get("fieldDefinition").attributeDefinition;return i&&!i.ReadOnly&&i.Constrained&&"OBJECT"!==i.AttributeType&&"COLLECTION"!==i.AttributeType}),e.getRecord()&&this.fireEvent("fieldselected",e.getRecord().get("fieldDefinition"))}},bubbleEvents:["fieldselected","fieldready"]},{name:"columns",readyEvent:"ready",fieldLabel:"",margin:"5px 0 0 80px",xtype:"kanbancolumnsettingsfield",shouldShowColumnLevelFieldPicker:i.shouldShowColumnLevelFieldPicker,defaultCardFields:i.defaultCardFields,handlesEvents:{fieldselected:function(e){this.refreshWithNewField(e)}},listeners:{ready:function(){this.fireEvent("columnsettingsready")}},bubbleEvents:"columnsettingsready"}];return t.push({name:"groupHorizontallyByField",xtype:"rowsettingsfield",fieldLabel:"Swimlanes",margin:"10 0 0 0",mapsToMultiplePreferenceKeys:["showRows","rowsField"],readyEvent:"ready",isAllowedFieldFn:function(e){var i=e.attributeDefinition;return!e.isMultiValueCustom()&&(i.Custom&&(i.Constrained||"string"!==i.AttributeType.toLowerCase())||i.Constrained||_.contains(["boolean"],i.AttributeType.toLowerCase()))&&!_.contains(["web_link","text","date"],i.AttributeType.toLowerCase())},explicitFields:[{name:"Sizing",value:"PlanEstimate"}]}),t.push({name:"hideReleasedCards",xtype:"rallycheckboxfield",fieldLabel:"Options",margin:"10 0 0 0",boxLabel:"Hide cards in last visible column if assigned to a release"},{type:"cardage",config:{fieldLabel:"",margin:"5 0 10 80"}},{type:"query"}),t}})}();
                !function(){var e=window.Ext4||window.Ext;e.define("Niks.Apps.DefectSuiteKanban",{extend:"Rally.app.App",requires:["Rally.apps.kanban.Settings","Rally.apps.kanban.Column","Rally.ui.gridboard.GridBoard","Rally.ui.gridboard.plugin.GridBoardAddNew","Rally.ui.gridboard.plugin.BoardPolicyDisplayable","Rally.ui.cardboard.plugin.ColumnPolicy","Rally.ui.cardboard.PolicyContainer","Rally.ui.cardboard.CardBoard","Rally.ui.cardboard.plugin.Scrollable","Rally.ui.report.StandardReport","Rally.clientmetrics.ClientMetricsRecordable","Rally.ui.gridboard.plugin.GridBoardCustomFilterControl","Rally.ui.gridboard.plugin.GridBoardFieldPicker","Rally.ui.cardboard.plugin.FixedHeader"],mixins:["Rally.clientmetrics.ClientMetricsRecordable"],cls:"kanban",alias:"widget.kanbanapp",appName:"Kanban",helpId:238,settingsScope:"project",autoScroll:!1,layout:"fit",config:{defaultSettings:{enabledModels:["DefectSuite"],groupByField:"ScheduleState",showRows:!1,columns:e.JSON.encode({Defined:{wip:""},"In-Progress":{wip:""},Completed:{wip:""},Accepted:{wip:""}}),cardFields:"FormattedID,Name,Owner,Discussion,Tasks,Defects",hideReleasedCards:!1,showCardAge:!0,cardAgeThreshold:3,pageSize:25}},_getSelectedModels:function(){var e=this.getSetting("enabledModels");return"string"==typeof e&&(e=e.split(",")),e},launch:function(){var e=this._getSelectedModels();0===e.length&&(e=["UserStory"]),Rally.data.ModelFactory.getModel({type:e[0],success:this._onStoryModelRetrieved,failure:function(e){console.log("Failed to fetch model: ",e)},scope:this})},getOptions:function(){return[{text:"Show Cycle Time Report",handler:this._showCycleTimeReport,scope:this},{text:"Show Throughput Report",handler:this._showThroughputReport,scope:this},{text:"Print",handler:this._print,scope:this}]},getSettingsFields:function(){return[{name:"enabledModels",fieldLabel:"Card Types",xtype:"rallycombobox",multiSelect:!0,displayField:"name",valueField:"name",storeType:"Ext.data.Store",stateful:!0,stateId:this.getContext().getScopedStateId("cardTypeSelector"),storeConfig:{remoteFilter:!1,fields:["name"],data:[{name:"DefectSuite"},{name:"Defect"},{name:"UserStory"},{name:"TestSet"},{name:"Risk"}]}}].concat(Rally.apps.kanban.Settings.getFields({shouldShowColumnLevelFieldPicker:this._shouldShowColumnLevelFieldPicker(),defaultCardFields:this.getSetting("cardFields")}))},onTimeboxScopeChange:function(){this.callParent(arguments),this.gridboard.destroy(),this.launch()},onSettingsUpdate:function(){this.gridboard&&this.gridboard.destroy(),this.launch()},_shouldShowColumnLevelFieldPicker:function(){return this.getContext().isFeatureEnabled("COLUMN_LEVEL_FIELD_PICKER_ON_KANBAN_SETTINGS")},_onStoryModelRetrieved:function(e){this.groupByField=e.getField(this.getSetting("groupByField")),this._addCardboardContent()},_addCardboardContent:function(){var e=this._getCardboardConfig(),t=this._getColumnSetting();t&&(e.columns=this._getColumnConfig(t)),this.gridboard=this.add(this._getGridboardConfig(e))},_getGridboardConfig:function(e){var t=this.getContext(),i=this._getDefaultTypes(),o=["Successors","Predecessors","DisplayColor"],r=["Milestones","Tags"];return{xtype:"rallygridboard",stateful:!1,toggleState:"board",cardBoardConfig:e,plugins:[{ptype:"rallygridboardaddnew",addNewControlConfig:{listeners:{beforecreate:this._onBeforeCreate,beforeeditorshow:this._onBeforeEditorShow,scope:this},stateful:!0,stateId:t.getScopedStateId("kanban-add-new"),modelNames:this._getSelectedModels()}},{ptype:"rallygridboardinlinefiltercontrol",inlineFilterButtonConfig:{stateful:!0,stateId:t.getScopedStateId("kanban-inline-filter"),modelNames:i,legacyStateIds:[t.getScopedStateId("kanban-owner-filter"),t.getScopedStateId("kanban-custom-filter-button")],filterChildren:!0,inlineFilterPanelConfig:{quickFilterPanelConfig:{defaultFields:["ArtifactSearch","Owner"],addQuickFilterConfig:{blackListFields:o,whiteListFields:r}},advancedFilterPanelConfig:{advancedFilterRowsConfig:{propertyFieldConfig:{blackListFields:o,whiteListFields:r}}}}}},{ptype:"rallygridboardfieldpicker",headerPosition:"left",boardFieldBlackList:o,modelNames:i},{ptype:"rallyboardpolicydisplayable",prefKey:"kanbanAgreementsChecked",checkboxConfig:{boxLabel:"Show Agreements"}}],context:t,modelNames:i,storeConfig:{filters:this._getFilters()},height:this.getHeight()}},_getColumnConfig:function(t){var i=[];return e.Object.each(t,function(e,t){var o={xtype:"kanbancolumn",enableWipLimit:!0,wipLimit:t.wip,plugins:[{ptype:"rallycolumnpolicy",app:this}],value:e,columnHeaderConfig:{headerTpl:e||"None"},listeners:{invalidfilter:{fn:this._onInvalidFilter,scope:this}}};this._shouldShowColumnLevelFieldPicker()&&(o.fields=this._getFieldsForColumn(t)),i.push(o)},this),i[i.length-1].hideReleasedCards=this.getSetting("hideReleasedCards"),i},_getFieldsForColumn:function(e){var t=[];return this._shouldShowColumnLevelFieldPicker()&&(e.cardFields?t=e.cardFields.split(","):this.getSetting("cardFields")&&(t=this.getSetting("cardFields").split(","))),t},_onInvalidFilter:function(){Rally.ui.notify.Notifier.showError({message:"Invalid query: "+this.getSetting("query")})},_getCardboardConfig:function(){var t={xtype:"rallycardboard",plugins:[{ptype:"rallycardboardprinting",pluginId:"print"},{ptype:"rallyscrollablecardboard",containerEl:this.getEl()},{ptype:"rallyfixedheadercardboard"}],types:this._getDefaultTypes(),attribute:this.getSetting("groupByField"),margin:"10px",context:this.getContext(),listeners:{beforecarddroppedsave:this._onBeforeCardSaved,load:this._onBoardLoad,cardupdated:this._publishContentUpdatedNoDashboardLayout,scope:this},columnConfig:{xtype:"rallycardboardcolumn",enableWipLimit:!0,fields:this.getSetting("cardFields").split(",")},cardConfig:{editable:!0,showIconMenus:!0,showAge:this.getSetting("showCardAge")?this.getSetting("cardAgeThreshold"):-1,showBlockedReason:!0},storeConfig:{context:this.getContext().getDataContext()}};return this.getSetting("showRows")&&e.merge(t,{rowConfig:{field:this.getSetting("rowsField"),sortDirection:"ASC"}}),t},_getFilters:function(){var e=[];return this.getSetting("query")&&e.push(Rally.data.QueryFilter.fromQueryString(this.getSetting("query"))),this.getContext().getTimeboxScope()&&e.push(this.getContext().getTimeboxScope().getQueryFilter()),e},_getColumnSetting:function(){var t=this.getSetting("columns");return t&&e.JSON.decode(t)},_buildReportConfig:function(e){var t={report:e,work_items:this._getWorkItemTypesForChart()};return"ScheduleState"!==this.getSetting("groupByField")&&(t.filter_field=this.groupByField.displayName),t},_showCycleTimeReport:function(){this._showReportDialog("Cycle Time Report",this._buildReportConfig(Rally.ui.report.StandardReport.Reports.CycleLeadTime))},_showThroughputReport:function(){this._showReportDialog("Throughput Report",this._buildReportConfig(Rally.ui.report.StandardReport.Reports.Throughput))},_print:function(){this.gridboard.getGridOrBoard().openPrintPage({title:"Kanban Board"})},_getWorkItemTypesForChart:function(){var e=this.gridboard.getGridOrBoard().getTypes();return 2===e.length?"N":{hierarchicalrequirement:"G",defect:"D"}[e[0]]},_getDefaultTypes:function(){return this._getSelectedModels()},_buildStandardReportConfig:function(e){var t=this.getContext().getDataContext();return{xtype:"rallystandardreport",padding:10,project:t.project,projectScopeUp:t.projectScopeUp,projectScopeDown:t.projectScopeDown,reportConfig:e}},_showReportDialog:function(t,i){this.getEl().mask(),e.create("Rally.ui.dialog.Dialog",{title:t,autoShow:!0,draggable:!1,closable:!0,modal:!1,height:450,width:600,items:[e.apply(this._buildStandardReportConfig(i),{height:450,width:600})],listeners:{close:function(){this.getEl().unmask()},scope:this}})},_onBoardLoad:function(){this._publishContentUpdated(),this.setLoading(!1)},_onBeforeCreate:function(t,i,o){e.apply(o,{rankTo:"BOTTOM",rankScope:"BACKLOG"}),i.set(this.getSetting("groupByField"),this.gridboard.getGridOrBoard().getColumns()[0].getValue())},_onBeforeEditorShow:function(e,t){t.rankTo="BOTTOM",t.rankScope="BACKLOG",t.iteration="u",t[this.groupByField.name]=this.gridboard.getGridOrBoard().getColumns()[0].getValue()},_onBeforeCardSaved:function(e,t){var i=this._getColumnSetting();if(i){var o=i[e.getValue()];o&&o.scheduleStateMapping&&t.getRecord().set("ScheduleState",o.scheduleStateMapping)}},_publishContentUpdated:function(){this.fireEvent("contentupdated"),Rally.BrowserTest&&Rally.BrowserTest.publishComponentReady(this),this.recordComponentReady({miscData:{swimLanes:this.getSetting("showRows"),swimLaneField:this.getSetting("rowsField")}})},_publishContentUpdatedNoDashboardLayout:function(){this.fireEvent("contentupdated",{dashboardLayout:!1})}})}();

            Rally.launchApp('Niks.Apps.DefectSuiteKanban', {
                name:"Kanban Board",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        .ext-ie .kanban .rly-right .filterInfo{width:25px}.ext-ie .kanban .rly-right .artifact-type-chooser{width:265px}.cardboard .status-content>.status-field.RevisionHistory{line-height:18px;cursor:default}.column-settings .settings-grid{border:1px solid #FFF}.column-settings .settings-grid.rally-invalid-field{border:1px solid #F00}.row-settings .x-form-item-input-row .x-field-label-cell{vertical-align:top}.rui-picker-right-action{display:inline;float:right;padding-right:4px}.kanban{overflow-y:hidden}.print-page .cardboard{height:auto !important}.print-page .cardboard .fixed-header-card-board-body-container>table{position:absolute;width:calc(100% - 24px)}
    </style>
</head>
<body>
</body>
</html>
